# 编译内核步骤
[toc]
# 添加系统调用

## 分配系统调用号

```c
// /arch/x86/entry/syscalls/syscall_64.tbl
335	64	sclab		__x64_sys_sclab
```

## 声明系统调用函数

```c
// include/linux/syscalls.h
asmlinkage long sys_sclab();
```

## 定义系统调用函数

```c
// kernel/sys.c
SYSCALL_DEFINE0(sclab){
	.....
}
```

# 编译内核

## 安装必要模块

```c
$ sudo apt-get install libncurses5-dev make openssl libssl-dev bison flex libelf-dev
```

## 配置内核选项

```c
$ make menuconfig
```

## 编译并安装

- -j4 是指4核编译 2>error.log是指将编译过程中错误信息输出到error.log文件中
- make modules_install是安装模块
- make install 是安装内核

```c
$ make -j4 2>error.log
$ make modules_install
$ make install
```

# 修改内核启动项更换内核

## 查看当前系统内核版本

```c
$ uname -a
```

## 查看GRUB选项

- 查看安装的自定义内核在哪个menuentry

```c
$ cat /boot/grub/grub.cfg
```

## 修改RGUB引导项

- 我们假设自定义内核在第5个menuentry，则做如下修改

```c
$ vim /etc/default/grub
// GRUB_DEFAULT=0修改为GRUB_DEFAULT="1 >4"
// 1是固定的，1后面必须有个空格
```